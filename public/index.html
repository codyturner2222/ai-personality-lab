<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Personality Lab</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0F0A2A;
            --bg-secondary: #1a1535;
            --bg-card: #F8F8FC;
            --accent-purple: #7C4DFF;
            --accent-teal: #00BCD4;
            --accent-gold: #FFB300;
            --text-primary: #ffffff;
            --text-secondary: #b8b8cc;
            --border-color: #2a2550;
            --error-color: #FF6B6B;
            --success-color: #51CF66;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* View Visibility */
        .view {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-in;
        }

        .view.active {
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Landing View */
        #landing-view {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .landing-content {
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        .app-title {
            font-size: clamp(2.5rem, 8vw, 4rem);
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent-teal) 0%, var(--accent-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(124, 77, 255, 0.3);
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% {
                filter: drop-shadow(0 0 10px rgba(124, 77, 255, 0.3));
            }
            50% {
                filter: drop-shadow(0 0 20px rgba(124, 77, 255, 0.6));
            }
        }

        .app-subtitle {
            font-size: clamp(1rem, 3vw, 1.5rem);
            color: var(--text-secondary);
            margin-bottom: 40px;
            font-weight: 300;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .button {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .button-primary {
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-teal) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(124, 77, 255, 0.3);
        }

        .button-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(124, 77, 255, 0.5);
        }

        .button-primary:active {
            transform: translateY(0);
        }

        .button-secondary {
            background: transparent;
            color: var(--accent-teal);
            border: 2px solid var(--accent-teal);
        }

        .button-secondary:hover {
            background: rgba(0, 188, 212, 0.1);
            transform: translateY(-2px);
        }

        .join-form {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            display: none;
            flex-direction: column;
            gap: 15px;
            animation: slideDown 0.3s ease-out;
        }

        .join-form.active {
            display: flex;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .group-picker-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 8px;
        }

        .group-picker-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .group-picker-card:hover {
            border-color: var(--accent-purple);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(124, 77, 255, 0.3);
        }

        .group-picker-card-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 4px;
        }

        .group-picker-card-prompt {
            font-size: 13px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .group-picker-card-members {
            font-size: 11px;
            color: var(--accent-teal);
            margin-top: 6px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--bg-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: white;
            color: var(--bg-primary);
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-teal);
            box-shadow: 0 0 10px rgba(0, 188, 212, 0.2);
        }

        .form-input::placeholder {
            color: #ccc;
        }

        /* Host Setup View */
        #host-setup-view {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            padding: 20px;
            overflow-y: auto;
        }

        .setup-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .setup-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--accent-teal);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .category-card {
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 60px;
        }

        .category-card:hover {
            border-color: var(--accent-teal);
            box-shadow: 0 4px 12px rgba(0, 188, 212, 0.2);
        }

        .category-card.selected {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
            color: white;
        }

        .category-name {
            font-weight: 600;
            color: var(--bg-primary);
            flex: 1;
        }

        .category-card.selected .category-name {
            color: white;
        }

        .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            flex-shrink: 0;
        }

        .category-card.selected .checkbox {
            background: white;
            border-color: white;
        }

        .checkbox::after {
            content: '✓';
            color: var(--accent-purple);
            font-weight: bold;
            font-size: 16px;
            display: none;
        }

        .category-card.selected .checkbox::after {
            display: block;
        }

        .groups-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .group-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .group-card:hover {
            border-color: var(--accent-teal);
            box-shadow: 0 4px 12px rgba(0, 188, 212, 0.2);
        }

        .group-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .group-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .group-input {
            flex: 1;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            font-weight: 600;
        }

        .group-input:focus {
            outline: none;
            border-color: var(--accent-teal);
        }

        .prompt-section {
            margin-bottom: 15px;
        }

        .prompt-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: block;
        }

        .prompt-select {
            width: 100%;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: border-color 0.3s ease;
            margin-bottom: 8px;
        }

        .prompt-select:focus {
            outline: none;
            border-color: var(--accent-teal);
        }

        .prompt-select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .prompt-custom {
            width: 100%;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
            transition: border-color 0.3s ease;
            display: none;
        }

        .prompt-custom:focus {
            outline: none;
            border-color: var(--accent-teal);
        }

        .prompt-custom.active {
            display: block;
        }

        .add-group-btn {
            background: var(--bg-primary);
            border: 2px dashed var(--accent-teal);
            color: var(--accent-teal);
            padding: 40px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
        }

        .add-group-btn:hover {
            background: rgba(0, 188, 212, 0.1);
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .remove-group-btn {
            background: transparent;
            border: none;
            color: var(--error-color);
            cursor: pointer;
            font-size: 20px;
            padding: 4px 8px;
            transition: all 0.3s ease;
        }

        .remove-group-btn:hover {
            transform: scale(1.2);
        }

        .launch-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-teal) 100%);
            border: none;
            border-radius: 8px;
            color: var(--bg-primary);
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(255, 179, 0, 0.3);
            transition: all 0.3s ease;
        }

        .launch-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 179, 0, 0.5);
        }

        /* Host Dashboard View */
        #host-dashboard-view {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            padding: 20px;
            overflow-y: auto;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .room-code-display {
            background: var(--bg-secondary);
            border: 3px solid var(--accent-gold);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(255, 179, 0, 0.2);
        }

        .room-code-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .room-code {
            font-size: clamp(48px, 15vw, 96px);
            font-weight: 700;
            color: var(--accent-gold);
            font-family: 'Courier New', monospace;
            letter-spacing: 10px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
        }

        .dashboard-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .control-button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-button-primary {
            background: var(--accent-teal);
            color: var(--bg-primary);
        }

        .control-button-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 188, 212, 0.3);
        }

        .control-button-secondary {
            background: transparent;
            color: var(--error-color);
            border: 2px solid var(--error-color);
        }

        .control-button-secondary:hover {
            background: rgba(255, 107, 107, 0.1);
        }

        .groups-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .group-dashboard-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .group-dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .dashboard-group-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--bg-primary);
            margin-bottom: 8px;
        }

        .dashboard-group-prompt {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
            line-height: 1.4;
            font-style: italic;
        }

        .members-count {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent-teal);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .members-list {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .stat-bar-mini {
            margin-top: 10px;
        }

        /* Student View */
        #student-view {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            flex-direction: column;
            overflow: hidden;
        }

        .student-header {
            background: var(--bg-secondary);
            padding: 15px 20px;
            border-bottom: 2px solid var(--border-color);
            flex-shrink: 0;
        }

        .group-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }

        .group-name-display {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-teal);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .group-prompt-display {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
            line-height: 1.4;
            max-width: 100%;
        }

        .category-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 15px 20px;
            border-bottom: 2px solid var(--border-color);
            scroll-behavior: smooth;
            flex-shrink: 0;
            -webkit-overflow-scrolling: touch;
        }

        .category-tabs::-webkit-scrollbar {
            height: 4px;
        }

        .category-tabs::-webkit-scrollbar-track {
            background: transparent;
        }

        .category-tabs::-webkit-scrollbar-thumb {
            background: var(--accent-purple);
            border-radius: 2px;
        }

        .category-tab {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-tab:hover {
            border-color: var(--accent-teal);
        }

        .category-tab.active {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
            color: white;
        }

        .progress-indicator {
            background: var(--bg-primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .category-tab.active .progress-indicator {
            background: rgba(255, 255, 255, 0.2);
        }

        .student-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 80px;
        }

        .options-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .option-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .option-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .option-card.answered::after {
            content: '✓';
            position: absolute;
            top: 15px;
            right: 15px;
            width: 28px;
            height: 28px;
            background: var(--success-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }

        .option-prompt {
            font-size: 16px;
            font-weight: 600;
            color: var(--bg-primary);
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-button {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            background: white;
            color: var(--bg-primary);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .choice-button:hover {
            border-color: var(--accent-teal);
            background: rgba(0, 188, 212, 0.05);
        }

        .choice-button.selected {
            background: var(--accent-purple);
            color: white;
            border-color: var(--accent-purple);
            box-shadow: 0 4px 12px rgba(124, 77, 255, 0.3);
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }

        .slider-range {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, #FF6B6B 0%, #FFB300 50%, #51CF66 100%);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        .slider-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent-purple);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(124, 77, 255, 0.4);
            transition: all 0.2s ease;
        }

        .slider-range::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(124, 77, 255, 0.6);
        }

        .slider-range::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent-purple);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(124, 77, 255, 0.4);
            transition: all 0.2s ease;
        }

        .slider-range::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(124, 77, 255, 0.6);
        }

        .slider-value {
            text-align: center;
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }

        /* Real-Time Fault Lines Ticker */
        .fault-lines-ticker {
            display: flex;
            gap: 8px;
            padding: 0 16px 8px 16px;
            overflow-x: auto;
            scrollbar-width: none;
            min-height: 0;
            flex-shrink: 0;
        }
        .fault-lines-ticker::-webkit-scrollbar { display: none; }
        .fault-lines-ticker:empty { display: none; }

        .fault-line-card {
            flex-shrink: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 12px;
            max-width: 220px;
            animation: faultLineSlideIn 0.4s ease-out;
            opacity: 1;
            transition: opacity 0.5s ease;
        }
        .fault-line-card.fading { opacity: 0; }

        .fault-line-group {
            font-weight: 600;
            font-size: 11px;
            margin-bottom: 3px;
            letter-spacing: 0.5px;
        }
        .fault-line-prompt {
            color: var(--text-secondary);
            font-size: 11px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .fault-line-choice {
            color: var(--text-primary);
            font-weight: 500;
        }

        @keyframes faultLineSlideIn {
            from { transform: translateX(40px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Chat View */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 700px;
            margin: 0 auto;
            padding: 0;
        }
        .chat-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px 20px 16px 20px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .chat-avatar-section {
            flex-shrink: 0;
        }
        .chat-header-info {
            flex: 1;
            min-width: 0;
        }
        .chat-ai-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-teal);
        }
        .chat-ai-traits {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
            line-height: 1.4;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .chat-welcome {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px 20px;
            font-size: 15px;
        }
        .chat-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }
        .chat-bubble-user {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--accent-purple), #5C3DCC);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-bubble-ai {
            align-self: flex-start;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }
        .chat-bubble-error {
            background: rgba(255, 107, 107, 0.15);
            border-color: var(--error-color);
            color: var(--error-color);
        }
        .chat-typing {
            padding: 8px 20px;
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            animation: typingPulse 1.2s ease-in-out infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingPulse {
            0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
            40% { opacity: 1; transform: scale(1); }
        }
        .chat-input-area {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .chat-input {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 12px 20px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        .chat-input:focus { border-color: var(--accent-purple); }
        .chat-send-btn {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-teal));
            color: white;
            border: none;
            border-radius: 24px;
            padding: 12px 24px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
        }
        .chat-send-btn:hover { transform: scale(1.05); }
        .chat-send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* Swap Gallery */
        .swap-gallery {
            position: fixed;
            top: 0;
            right: 0;
            width: 280px;
            height: 100%;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            z-index: 90;
        }
        .swap-gallery-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
        }
        .swap-gallery-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .swap-ai-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .swap-ai-card:hover { border-color: var(--accent-teal); transform: translateY(-2px); }
        .swap-ai-card.active { border-color: var(--accent-gold); box-shadow: 0 0 12px rgba(255, 179, 0, 0.3); }
        .swap-ai-name {
            font-weight: 600;
            font-size: 13px;
            margin-top: 8px;
        }
        .swap-ai-summary {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            line-height: 1.3;
        }

        /* Profile Card -- compact floating button */
        .profile-card-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--accent-purple);
            border-radius: 50px;
            padding: 10px 20px 10px 14px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 260px;
        }

        .profile-card-container:hover {
            border-color: var(--accent-teal);
            box-shadow: 0 12px 40px rgba(0, 188, 212, 0.3);
            transform: translateY(-4px);
        }

        .profile-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .profile-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .avatar-canvas-container {
            width: 100%;
            text-align: center;
            margin-bottom: 15px;
        }

        #avatar-canvas {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        .completion-percentage {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .stat-item {
            background: rgba(124, 77, 255, 0.1);
            padding: 10px;
            border-radius: 6px;
        }

        .stat-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-teal);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 4px;
        }

        .stat-bar-horizontal {
            width: 100%;
            height: 4px;
            background: rgba(0, 188, 212, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }

        .stat-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-purple) 0%, var(--accent-teal) 100%);
            width: 0%;
            transition: width 0.4s ease;
        }

        .stat-value {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 3px;
        }

        .badges-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .badge {
            background: var(--accent-gold);
            color: var(--bg-primary);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* Expanded Profile View */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .profile-modal.active {
            display: flex;
        }

        .profile-modal-content {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 40px 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .profile-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 32px;
            height: 32px;
            background: transparent;
            border: 2px solid var(--text-secondary);
            border-radius: 50%;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .profile-modal-close:hover {
            border-color: var(--accent-teal);
            color: var(--accent-teal);
        }

        .profile-modal-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-teal);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .profile-modal-avatar {
            width: 100%;
            max-width: 250px;
            margin: 30px auto;
        }

        #avatar-canvas-modal {
            width: 100%;
            height: auto;
        }

        .stats-full {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 30px 0;
        }

        .stat-bar-full {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .stat-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-bar-background {
            width: 100%;
            height: 8px;
            background: rgba(0, 188, 212, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .stat-bar-fill-full {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-purple) 0%, var(--accent-teal) 100%);
            width: 0%;
            transition: width 0.4s ease;
            border-radius: 4px;
        }

        /* Comparison View */
        #comparison-view {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            padding: 30px 20px;
            overflow-y: auto;
        }

        .comparison-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .comparison-title {
            font-size: 36px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 40px;
            color: var(--accent-teal);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .comparison-groups {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 30px;
            justify-items: center;
        }

        .comparison-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.5s ease;
        }

        .comparison-group-name {
            font-size: 24px;
            font-weight: 700;
            color: var(--bg-primary);
            text-align: center;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .comparison-group-prompt {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.5;
            font-style: italic;
        }

        .comparison-avatar {
            width: 100%;
            max-width: 200px;
            margin: 20px auto;
            text-align: center;
        }

        #avatar-canvas-comparison {
            width: 100%;
            height: auto;
        }

        .comparison-stats {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }

        .comparison-stat {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .comparison-stat-label {
            min-width: 90px;
            font-size: 12px;
            font-weight: 600;
            color: var(--bg-primary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .comparison-stat-bar {
            flex: 1;
            height: 6px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .comparison-stat-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-purple) 0%, var(--accent-teal) 100%);
            width: 0%;
            transition: width 0.4s ease;
        }

        .comparison-stat-value {
            min-width: 35px;
            font-size: 12px;
            font-weight: 600;
            color: var(--bg-primary);
            text-align: right;
        }

        .comparison-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .comparison-member-count {
            font-size: 13px;
            color: #666;
            text-align: center;
            margin-top: 15px;
            font-weight: 500;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(124, 77, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-purple);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .error-message {
            background: var(--error-color);
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }

        .success-message {
            background: var(--success-color);
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .category-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .groups-container {
                grid-template-columns: 1fr;
            }

            .groups-dashboard {
                grid-template-columns: 1fr;
            }

            .options-container {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .comparison-groups {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .profile-card-container {
                right: 10px;
                max-width: none;
            }

            .student-content {
                padding-bottom: 80px;
            }

            .profile-modal-content {
                padding: 30px 20px;
                max-height: 95vh;
            }

            .profile-modal-close {
                top: 15px;
                right: 15px;
            }
        }

        @media (max-width: 480px) {
            .category-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .section-title {
                font-size: 18px;
            }

            .app-title {
                font-size: 2rem;
            }

            .room-code {
                font-size: 48px;
                letter-spacing: 5px;
            }

            .comparison-title {
                font-size: 24px;
            }

            .comparison-groups {
                grid-template-columns: 1fr;
            }

            .student-content {
                padding: 15px;
                padding-bottom: 280px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Landing View -->
        <div id="landing-view" class="view active">
            <div class="landing-content">
                <h1 class="app-title">AI Personality Lab</h1>
                <p class="app-subtitle">Design Your AI Companion</p>

                <div class="button-group">
                    <button class="button button-primary" id="create-session-btn">
                        Create Session
                    </button>
                    <button class="button button-secondary" id="join-session-btn">
                        Join Session
                    </button>
                </div>

                <div class="join-form" id="join-form">
                    <div class="form-group">
                        <label class="form-label">Room Code</label>
                        <input
                            type="text"
                            class="form-input"
                            id="room-code-input"
                            placeholder="Enter 4-letter code"
                            maxlength="4"
                            autocomplete="off"
                        >
                    </div>
                    <button class="button button-secondary" id="lookup-groups-btn">
                        Find Session
                    </button>
                    <div class="group-picker" id="group-picker" style="display: none;">
                        <label class="form-label" style="margin-top: 16px;">Select Your Group</label>
                        <div class="group-picker-list" id="group-picker-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Host Setup View -->
        <div id="host-setup-view" class="view">
            <div class="setup-container">
                <h2 class="section-title">Select Categories</h2>
                <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">Choose which design categories students will see. All are selected by default.</p>
                <div class="category-grid" id="categories-grid">
                    <!-- Populated by JS -->
                </div>

                <h2 class="section-title" style="margin-top: 28px;">Number of Groups</h2>
                <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">How many groups are you splitting the class into?</p>
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
                    <button class="button button-secondary" id="groups-minus" style="width: 44px; height: 44px; padding: 0; font-size: 22px; border-radius: 50%;">-</button>
                    <span id="group-count-display" style="font-size: 36px; font-weight: 700; color: var(--accent-gold); min-width: 40px; text-align: center;">3</span>
                    <button class="button button-secondary" id="groups-plus" style="width: 44px; height: 44px; padding: 0; font-size: 22px; border-radius: 50%;">+</button>
                </div>

                <button class="launch-button" id="launch-session-btn">
                    Launch Session
                </button>
            </div>
        </div>

        <!-- Host Dashboard View -->
        <div id="host-dashboard-view" class="view">
            <div class="dashboard-container">
                <div class="room-code-display">
                    <div class="room-code-label">Room Code</div>
                    <div class="room-code" id="dashboard-room-code">----</div>
                </div>

                <div class="dashboard-controls">
                    <button class="control-button control-button-primary" id="show-comparison-btn">
                        Show Comparison
                    </button>
                    <button class="control-button" id="start-chat-btn" style="background: linear-gradient(135deg, var(--accent-teal), var(--accent-purple)); color: white; border: none;">
                        Start Chat Phase
                    </button>
                    <button class="control-button" id="enable-swap-btn" style="background: linear-gradient(135deg, var(--accent-gold), #FF6B6B); color: white; border: none; display: none;">
                        Enable Swap Mode
                    </button>
                    <button class="control-button control-button-secondary" id="reset-session-btn">
                        Reset Session
                    </button>
                </div>

                <div class="groups-dashboard" id="groups-dashboard">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Student View -->
        <div id="student-view" class="view">
            <div class="student-header">
                <div class="group-info">
                    <div>
                        <div class="group-name-display" id="student-group-name">Group A</div>
                    </div>
                </div>
            </div>

            <div class="category-tabs" id="category-tabs">
                <!-- Populated by JS -->
            </div>

            <!-- Real-Time Fault Lines Ticker -->
            <div class="fault-lines-ticker" id="fault-lines-ticker">
                <!-- Populated by JS when other groups make choices -->
            </div>

            <div class="student-content">
                <div class="options-container" id="options-container">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Profile Card (Compact Floating Button) -->
            <div class="profile-card-container" id="profile-card">
                <canvas id="avatar-canvas" width="44" height="44" style="border-radius: 50%; flex-shrink: 0;"></canvas>
                <div style="display: flex; flex-direction: column; gap: 2px;">
                    <div class="profile-title">Your AI Profile</div>
                    <div style="font-size: 13px; color: var(--text-secondary);"><span id="completion-percent">0</span>% Complete</div>
                </div>
            </div>
        </div>

        <!-- Comparison View -->
        <div id="comparison-view" class="view">
            <div class="comparison-container">
                <h1 class="comparison-title">AI Profile Comparison</h1>
                <div class="comparison-groups" id="comparison-groups">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Chat View -->
        <div id="chat-view" class="view">
            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-avatar-section">
                        <canvas id="chat-avatar-canvas" width="120" height="120"></canvas>
                    </div>
                    <div class="chat-header-info">
                        <div class="chat-ai-name" id="chat-ai-name">Your AI</div>
                        <div class="chat-ai-traits" id="chat-ai-traits"></div>
                    </div>
                </div>
                <div class="chat-messages" id="chat-messages">
                    <div class="chat-welcome" id="chat-welcome">
                        <p>Your AI is ready to talk. Say hello!</p>
                    </div>
                </div>
                <div class="chat-typing" id="chat-typing" style="display: none;">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chat-input" placeholder="Type a message..." maxlength="500" autocomplete="off">
                    <button class="chat-send-btn" id="chat-send-btn">Send</button>
                </div>
            </div>

            <!-- Swap Mode: AI Gallery (shown when swap is active) -->
            <div class="swap-gallery" id="swap-gallery" style="display: none;">
                <div class="swap-gallery-title">Other Groups' AIs</div>
                <div class="swap-gallery-grid" id="swap-gallery-grid">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Expanded Profile Modal -->
        <div class="profile-modal" id="profile-modal">
            <div class="profile-modal-content">
                <button class="profile-modal-close" id="profile-modal-close">&times;</button>
                <h2 class="profile-modal-title">Your AI Profile</h2>
                <div class="profile-modal-avatar">
                    <canvas id="avatar-canvas-modal" width="250" height="250"></canvas>
                </div>
                <div class="stats-full" id="modal-stats-container">
                    <!-- Dynamically populated based on active dimensions -->
                </div>
                <div class="badges-container" id="modal-badges-container">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // =====================================================================
        // STATE MANAGEMENT
        // =====================================================================

        const state = {
            currentView: 'landing',
            role: null, // 'host' or 'student'
            roomCode: null,
            groupId: null,
            groupName: null,
            groupPrompt: null,
            studentName: null,
            studentId: null,
            activeCategories: [],
            activeDimensions: ['warmth', 'honesty', 'autonomy', 'memory', 'boundaries', 'availability', 'transparency'],
            groups: [],
            activeOptions: [],
            currentCategoryId: null,
            selectedOptions: {}, // { optionId: choiceId | value }
            selections: {}, // tracks answered count for completion
            profile: {
                dimensions: {
                    warmth: 0,
                    honesty: 0,
                    autonomy: 0,
                    memory: 0,
                    boundaries: 0,
                    availability: 0,
                    transparency: 0
                },
                badges: [],
                features: [],
                avatarShape: 'circle',
                avatarColor: '#7C4DFF',
                completionPercent: 0
            },
            groupAggregates: {},
            // Chat state
            phase: 'design', // 'design' | 'chat' | 'swap'
            chatMessages: [],
            currentChatGroupId: null,
            isWaitingForResponse: false,
            allGroupSummaries: {}
        };

        // =====================================================================
        // SOCKET.IO CONNECTION
        // =====================================================================

        const socket = io();

        socket.on('connect', () => {
            console.log('Connected to server');

            // Try to reconnect as host if we have a saved session
            try {
                const saved = sessionStorage.getItem('ailab_host');
                if (saved) {
                    const { roomCode } = JSON.parse(saved);
                    if (roomCode && state.currentView === 'landing') {
                        socket.emit('rejoin-host', { roomCode });
                    }
                }
            } catch(e) {}
        });

        // Host reconnection response
        socket.on('host-rejoined', (data) => {
            state.role = 'host';
            state.roomCode = data.roomCode;
            if (data.activeDimensions) state.activeDimensions = data.activeDimensions;

            state.groups = Object.entries(data.groups).map(([id, group]) => ({
                id: String(id),
                name: group.name,
                prompt: group.prompt,
                members: []
            }));

            // Initialize groupAggregates
            state.groups.forEach(group => {
                if (!state.groupAggregates[group.id]) {
                    state.groupAggregates[group.id] = {
                        groupId: group.id,
                        groupName: group.name,
                        memberCount: 0,
                        members: [],
                        aggregate: {
                            dimensions: { warmth: 0, honesty: 0, autonomy: 0, memory: 0, boundaries: 0, availability: 0, transparency: 0 },
                            badges: [], features: [], avatarShape: 'circle', avatarColor: '#7C4DFF'
                        }
                    };
                }
            });

            showView('host-dashboard');
            renderDashboard();
            showSuccess('Reconnected to session ' + data.roomCode);
        });

        socket.on('error', (data) => {
            showError(data.message || 'An error occurred');
        });

        socket.on('session-created', (data) => {
            state.roomCode = data.roomCode;
            if (data.activeDimensions) state.activeDimensions = data.activeDimensions;
            // Convert groups object to array format for easier iteration
            state.groups = Object.entries(data.groups).map(([id, group]) => ({
                id: String(id),
                name: group.name,
                prompt: group.prompt,
                members: []
            }));
            // Initialize groupAggregates for all groups
            state.groups.forEach(group => {
                state.groupAggregates[group.id] = {
                    groupId: group.id,
                    groupName: group.name,
                    memberCount: 0,
                    members: [],
                    aggregate: {
                        dimensions: { warmth: 0, honesty: 0, autonomy: 0, memory: 0, boundaries: 0, availability: 0, transparency: 0 },
                        badges: [],
                        features: [],
                        avatarShape: 'circle',
                        avatarColor: '#7C4DFF'
                    }
                };
            });
            showView('host-dashboard');
            renderDashboard();

            // Save session for reconnection on refresh
            try { sessionStorage.setItem('ailab_host', JSON.stringify({ roomCode: state.roomCode })); } catch(e) {}
        });

        socket.on('session-joined', (data) => {
            state.roomCode = data.roomCode;
            state.groupId = data.groupId;
            state.groupName = data.groupName;
            state.groupPrompt = data.groupPrompt;
            state.activeOptions = data.activeOptions;
            if (data.activeDimensions) state.activeDimensions = data.activeDimensions;

            // Find the first category to show
            if (state.activeOptions.length > 0) {
                state.currentCategoryId = state.activeOptions[0].categoryId;
            }

            showView('student');
            renderStudentView();
        });

        socket.on('profile-updated', (data) => {
            // Only update if this is our own profile
            if (data.studentId === socket.id) {
                state.profile = data.profile;
                // Compute completion percentage
                const totalOptions = state.activeOptions ? state.activeOptions.length : 85;
                const answered = Object.keys(state.selections || {}).length;
                state.profile.completionPercent = Math.round((answered / totalOptions) * 100);
                updateProfileCard();
            }
        });

        socket.on('group-updated', (data) => {
            // Preserve existing members list and update aggregate data
            const existingMembers = state.groupAggregates[data.groupId]?.members || [];
            state.groupAggregates[data.groupId] = {
                ...data,
                members: existingMembers
            };
            updateDashboardGroup(data.groupId);

            // Auto-refresh comparison view if it's currently showing
            if (state.currentView === 'comparison') {
                renderComparisonView();
            }
        });

        // Real-time fault lines -- another group made a choice
        socket.on('choice-broadcast', (data) => {
            // Only show choices from OTHER groups
            if (state.role !== 'student') return;
            if (String(data.groupId) === String(state.groupId)) return;
            if (!data.choiceText) return;

            const ticker = document.getElementById('fault-lines-ticker');
            if (!ticker) return;

            const groupColors = ['#7C4DFF', '#00BCD4', '#FFB300', '#FF6B6B', '#51CF66', '#FF8A65', '#4FC3F7', '#E040FB'];
            const gIdx = parseInt(data.groupId) || 0;
            const gColor = groupColors[gIdx % groupColors.length];

            const card = document.createElement('div');
            card.className = 'fault-line-card';
            card.style.borderLeftColor = gColor;
            card.style.borderLeftWidth = '3px';
            card.innerHTML =
                '<div class="fault-line-group" style="color: ' + gColor + ';">' + (data.groupName || 'Group') + '</div>' +
                '<div class="fault-line-prompt">' + (data.optionPrompt || '') + '</div>' +
                '<div class="fault-line-choice">' + data.choiceText + '</div>';

            ticker.appendChild(card);
            ticker.scrollLeft = ticker.scrollWidth;

            // Auto-remove after 10 seconds
            setTimeout(() => {
                card.classList.add('fading');
                setTimeout(() => card.remove(), 500);
            }, 10000);

            // Keep max 6 visible
            while (ticker.children.length > 6) {
                ticker.removeChild(ticker.firstChild);
            }
        });

        socket.on('student-joined', (data) => {
            // Track the new member in the group aggregate
            if (state.groupAggregates[data.groupId]) {
                if (!state.groupAggregates[data.groupId].members) {
                    state.groupAggregates[data.groupId].members = [];
                }
                state.groupAggregates[data.groupId].members.push(data.studentName);
            }
            updateDashboardGroup(data.groupId);
        });

        socket.on('comparison-data', (data) => {
            state.groupAggregates = {};
            if (data.activeDimensions) state.activeDimensions = data.activeDimensions;
            data.groups.forEach(group => {
                state.groupAggregates[group.groupId] = group;
            });
            renderComparisonView();
        });

        socket.on('student-left', (data) => {
            // Remove student from the group's member list
            for (const groupId in state.groupAggregates) {
                const group = state.groupAggregates[groupId];
                if (group.members) {
                    group.members = group.members.filter(m => m !== data.studentName);
                    if (group.memberCount > 0) {
                        group.memberCount--;
                    }
                }
            }
            // Update dashboard display
            if (state.currentView === 'host-dashboard') {
                renderDashboard();
            }
        });

        socket.on('session-reset', () => {
            // Clear all group data and selections
            state.groupAggregates = {};
            state.selections = {};
            state.selectedOptions = {};
            if (state.currentView === 'host-dashboard') {
                renderDashboard();
            } else if (state.currentView === 'student') {
                renderStudentView();
            }
        });

        // =====================================================================
        // CHAT PHASE EVENTS
        // =====================================================================

        socket.on('chat-phase-started', (data) => {
            state.phase = 'chat';
            state.chatMessages = [];
            state.currentChatGroupId = String(state.groupId);
            state.allGroupSummaries = data.groupSummaries || {};
            if (data.activeDimensions) state.activeDimensions = data.activeDimensions;

            if (state.role === 'student') {
                showView('chat');
                renderChatView();
            } else {
                // Host: show swap button
                const swapBtn = document.getElementById('enable-swap-btn');
                if (swapBtn) swapBtn.style.display = 'inline-flex';
            }
        });

        socket.on('chat-response', (data) => {
            const typing = document.getElementById('chat-typing');
            if (typing) typing.style.display = 'none';

            const messagesEl = document.getElementById('chat-messages');
            if (!messagesEl) return;

            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble chat-bubble-ai' + (data.error ? ' chat-bubble-error' : '');
            bubble.textContent = data.text;
            messagesEl.appendChild(bubble);
            messagesEl.scrollTop = messagesEl.scrollHeight;

            // Re-draw avatar (it can react to conversation)
            const chatCanvas = document.getElementById('chat-avatar-canvas');
            if (chatCanvas) {
                const summary = state.allGroupSummaries[state.currentChatGroupId];
                if (summary && summary.aggregate) {
                    const groupColors = ['#7C4DFF', '#00BCD4', '#FFB300', '#FF6B6B', '#51CF66', '#FF8A65', '#4FC3F7', '#E040FB'];
                    const gIdx = parseInt(state.currentChatGroupId) || 0;
                    drawExpressiveAvatar(chatCanvas, summary.aggregate.dimensions, state.activeDimensions, 120, groupColors[gIdx % groupColors.length]);
                }
            }

            state.isWaitingForResponse = false;
            const sendBtn = document.getElementById('chat-send-btn');
            if (sendBtn) sendBtn.disabled = false;
        });

        socket.on('chat-typing', (data) => {
            const typing = document.getElementById('chat-typing');
            if (typing) typing.style.display = data.isTyping ? 'flex' : 'none';
        });

        socket.on('swap-mode-active', (data) => {
            state.phase = 'swap';
            state.allGroupSummaries = data.groupSummaries || {};
            if (data.activeDimensions) state.activeDimensions = data.activeDimensions;

            if (state.role === 'student') {
                // Show the swap gallery
                renderSwapGallery();
            }
        });

        // =====================================================================
        // VIEW MANAGEMENT
        // =====================================================================

        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            state.currentView = viewName;

            switch(viewName) {
                case 'landing':
                    document.getElementById('landing-view').classList.add('active');
                    break;
                case 'host-setup':
                    document.getElementById('host-setup-view').classList.add('active');
                    renderSetupView();
                    break;
                case 'host-dashboard':
                    document.getElementById('host-dashboard-view').classList.add('active');
                    break;
                case 'student':
                    document.getElementById('student-view').classList.add('active');
                    break;
                case 'comparison':
                    document.getElementById('comparison-view').classList.add('active');
                    break;
                case 'chat':
                    document.getElementById('chat-view').classList.add('active');
                    break;
            }
        }

        // =====================================================================
        // LANDING VIEW
        // =====================================================================

        document.getElementById('create-session-btn').addEventListener('click', () => {
            state.role = 'host';
            showView('host-setup');
        });

        document.getElementById('join-session-btn').addEventListener('click', () => {
            document.getElementById('join-form').classList.add('active');
            document.getElementById('room-code-input').focus();
        });

        document.getElementById('room-code-input').addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase().replace(/[^A-Z]/g, '');
        });

        // Look up the session and show available groups
        document.getElementById('lookup-groups-btn').addEventListener('click', () => {
            const roomCode = document.getElementById('room-code-input').value.trim();

            if (!roomCode || roomCode.length !== 4) {
                showError('Please enter a 4-letter room code');
                return;
            }

            fetch('/api/session/' + roomCode)
                .then(res => {
                    if (!res.ok) throw new Error('Session not found');
                    return res.json();
                })
                .then(data => {
                    const picker = document.getElementById('group-picker');
                    const list = document.getElementById('group-picker-list');
                    list.innerHTML = '';

                    const groups = data.groups || {};
                    Object.entries(groups).forEach(([groupId, group]) => {
                        const card = document.createElement('div');
                        card.className = 'group-picker-card';
                        card.innerHTML = `
                            <div class="group-picker-card-name">${group.name}</div>
                        `;
                        card.addEventListener('click', () => {
                            state.role = 'student';
                            state.studentName = group.name;
                            socket.emit('join-session', {
                                roomCode,
                                studentName: group.name,
                                requestedGroupId: groupId
                            });
                        });
                        list.appendChild(card);
                    });

                    picker.style.display = 'block';
                })
                .catch(err => {
                    showError('Session not found. Check the room code.');
                });
        });

        // =====================================================================
        // HOST SETUP VIEW
        // =====================================================================

        const CATEGORIES = [
            { id: 'identity', name: 'Identity & Embodiment' },
            { id: 'personality', name: 'Personality & Communication' },
            { id: 'honesty', name: 'Honesty & Feedback' },
            { id: 'memory', name: 'Memory & Awareness' },
            { id: 'boundaries', name: 'Boundaries & Power' },
            { id: 'relationship', name: 'Relationship & Attachment' },
            { id: 'ethics', name: 'Ethics, Values & Secrets' },
            { id: 'availability', name: 'Availability & Presence' },
            { id: 'growth', name: 'Growth, Change & Mortality' },
            { id: 'transparency', name: 'Transparency & the Company' }
        ];

        let groupCount = 3;

        function renderSetupView() {
            // Render category grid
            const categoriesGrid = document.getElementById('categories-grid');
            categoriesGrid.innerHTML = '';
            state.activeCategories = [];

            CATEGORIES.forEach(category => {
                const card = document.createElement('div');
                card.className = 'category-card selected';
                card.dataset.categoryId = category.id;

                card.innerHTML = `
                    <span class="category-name">${category.name}</span>
                    <div class="checkbox"></div>
                `;

                card.addEventListener('click', () => {
                    card.classList.toggle('selected');
                    updateActiveCategories();
                });

                categoriesGrid.appendChild(card);
                state.activeCategories.push(category.id);
            });

            // Update group count display
            document.getElementById('group-count-display').textContent = groupCount;
        }

        function updateActiveCategories() {
            state.activeCategories = Array.from(document.querySelectorAll('.category-card.selected'))
                .map(card => card.dataset.categoryId);
        }

        document.getElementById('groups-minus').addEventListener('click', () => {
            if (groupCount > 1) {
                groupCount--;
                document.getElementById('group-count-display').textContent = groupCount;
            }
        });

        document.getElementById('groups-plus').addEventListener('click', () => {
            if (groupCount < 8) {
                groupCount++;
                document.getElementById('group-count-display').textContent = groupCount;
            }
        });

        document.getElementById('launch-session-btn').addEventListener('click', () => {
            if (state.activeCategories.length === 0) {
                showError('Please select at least one category');
                return;
            }

            // Build groups array from count
            const groups = [];
            for (let i = 0; i < groupCount; i++) {
                const letter = String.fromCharCode(65 + i);
                groups.push({ name: 'Group ' + letter, prompt: 'Group ' + letter });
            }
            state.groups = groups;

            socket.emit('create-session', {
                activeCategories: state.activeCategories,
                groups: groups
            });
        });

        // =====================================================================
        // HOST DASHBOARD VIEW
        // =====================================================================

        function renderDashboard() {
            document.getElementById('dashboard-room-code').textContent = state.roomCode;

            const dashboard = document.getElementById('groups-dashboard');
            dashboard.innerHTML = '';

            state.groups.forEach((group, index) => {
                const aggregateData = state.groupAggregates[group.id] || {
                    memberCount: 0,
                    members: [],
                    aggregate: { dimensions: {} }
                };

                const card = document.createElement('div');
                card.className = 'group-dashboard-card';
                card.id = `dashboard-group-${group.id}`;

                const groupLetter = String.fromCharCode(65 + index);
                const membersList = aggregateData.members || [];

                card.innerHTML = `
                    <div class="dashboard-group-name">Group ${groupLetter}</div>
                    <div class="dashboard-group-prompt">"${group.prompt}"</div>
                    <div class="members-count">${aggregateData.memberCount} member${aggregateData.memberCount !== 1 ? 's' : ''}</div>
                    <div class="members-list">
                        ${membersList.length > 0 ? membersList.map(m => `<div>• ${m}</div>`).join('') : '<div style="color: #999;">Waiting for students...</div>'}
                    </div>
                `;

                dashboard.appendChild(card);
            });
        }

        function updateDashboardGroup(groupId) {
            groupId = String(groupId);
            const aggregateData = state.groupAggregates[groupId];
            if (!aggregateData) return;

            const groupIndex = state.groups.findIndex(g => String(g.id) === groupId);
            if (groupIndex === -1) return;

            const card = document.getElementById(`dashboard-group-${groupId}`);
            if (!card) return;

            const groupLetter = String.fromCharCode(65 + groupIndex);
            const group = state.groups[groupIndex];
            const membersList = aggregateData.members || [];

            card.innerHTML = `
                <div class="dashboard-group-name">Group ${groupLetter}</div>
                <div class="dashboard-group-prompt">"${group.prompt}"</div>
                <div class="members-count">${aggregateData.memberCount} member${aggregateData.memberCount !== 1 ? 's' : ''}</div>
                <div class="members-list">
                    ${membersList.length > 0 ? membersList.map(m => `<div>• ${m}</div>`).join('') : '<div style="color: #999;">Waiting for students...</div>'}
                </div>
            `;
        }

        document.getElementById('show-comparison-btn').addEventListener('click', () => {
            socket.emit('show-comparison', { roomCode: state.roomCode });
            renderComparisonView();
            showView('comparison');
        });

        document.getElementById('reset-session-btn').addEventListener('click', () => {
            if (confirm('Are you sure you want to reset the session? All student selections will be cleared.')) {
                socket.emit('reset-session', { roomCode: state.roomCode });
                state.groupAggregates = {};
                try { sessionStorage.removeItem('ailab_host'); } catch(e) {}
                renderDashboard();
            }
        });

        // Host: Start Chat Phase
        document.getElementById('start-chat-btn').addEventListener('click', () => {
            socket.emit('start-chat-phase', { roomCode: state.roomCode });
        });

        // Host: Enable Swap Mode
        document.getElementById('enable-swap-btn').addEventListener('click', () => {
            socket.emit('enable-swap-mode', { roomCode: state.roomCode });
        });

        // Chat: Send message
        document.getElementById('chat-send-btn').addEventListener('click', sendChatMessage);
        document.getElementById('chat-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        });

        // =====================================================================
        // STUDENT VIEW
        // =====================================================================

        function renderStudentView() {
            document.getElementById('student-group-name').textContent = state.groupName;
            // Group prompt removed -- assigned verbally by instructor

            renderCategoryTabs();
            renderOptions();
        }

        // Build a lookup from categoryId to human-readable name
        const CATEGORY_NAME_MAP = {};
        CATEGORIES.forEach(c => { CATEGORY_NAME_MAP[c.id] = c.name; });

        function renderCategoryTabs() {
            const tabsContainer = document.getElementById('category-tabs');
            tabsContainer.innerHTML = '';

            // Extract unique categories from activeOptions (preserving order)
            const seen = {};
            const uniqueCategories = [];
            state.activeOptions.forEach(option => {
                if (!seen[option.categoryId]) {
                    seen[option.categoryId] = true;
                    uniqueCategories.push(option.categoryId);
                }
            });

            uniqueCategories.forEach((catId, index) => {
                const tab = document.createElement('button');
                tab.className = 'category-tab';
                if (catId === state.currentCategoryId) tab.classList.add('active');

                // Count answered questions in this category
                const categoryOptions = state.activeOptions.filter(o => o.categoryId === catId);
                const answeredCount = categoryOptions.filter(o => state.selectedOptions[o.id] !== undefined).length;

                const catName = CATEGORY_NAME_MAP[catId] || catId;
                tab.innerHTML = `
                    <span>${catName}</span>
                    <div class="progress-indicator">${answeredCount}/${categoryOptions.length}</div>
                `;

                tab.addEventListener('click', () => {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    state.currentCategoryId = catId;
                    renderOptions();
                });

                tabsContainer.appendChild(tab);
            });
        }

        function renderOptions() {
            const container = document.getElementById('options-container');
            container.innerHTML = '';

            const categoryOptions = state.activeOptions.filter(o => o.categoryId === state.currentCategoryId);

            categoryOptions.forEach(option => {
                const card = document.createElement('div');
                card.className = 'option-card';
                if (state.selectedOptions[option.id] !== undefined) {
                    card.classList.add('answered');
                }

                card.innerHTML = `<div class="option-prompt">${option.prompt}</div>`;

                if (option.type === 'choice') {
                    const buttonContainer = document.createElement('div');
                    buttonContainer.className = 'choice-buttons';

                    option.choices.forEach(choice => {
                        const btn = document.createElement('button');
                        btn.className = 'choice-button';
                        btn.textContent = choice.text;

                        if (state.selectedOptions[option.id] === choice.id) {
                            btn.classList.add('selected');
                        }

                        btn.addEventListener('click', () => {
                            state.selectedOptions[option.id] = choice.id;
                            if (!state.selections) state.selections = {};
                            state.selections[option.id] = choice.id;
                            socket.emit('select-option', {
                                roomCode: state.roomCode,
                                optionId: option.id,
                                choiceId: choice.id
                            });

                            // Update visual
                            card.classList.add('answered');
                            card.querySelectorAll('.choice-button').forEach(b => b.classList.remove('selected'));
                            btn.classList.add('selected');

                            // Update tabs
                            renderCategoryTabs();
                        });

                        buttonContainer.appendChild(btn);
                    });

                    card.appendChild(buttonContainer);
                } else if (option.type === 'slider') {
                    const sliderContainer = document.createElement('div');
                    sliderContainer.className = 'slider-container';

                    const currentValue = state.selectedOptions[option.id] !== undefined ?
                        state.selectedOptions[option.id] : 50;

                    sliderContainer.innerHTML = `
                        <div class="slider-labels">
                            <span>${option.labels ? option.labels[0] : ''}</span>
                            <span>${option.labels ? option.labels[1] : ''}</span>
                        </div>
                        <input
                            type="range"
                            class="slider-range"
                            min="0"
                            max="100"
                            value="${currentValue}"
                        >
                        <div class="slider-value">${currentValue}</div>
                    `;

                    const slider = sliderContainer.querySelector('.slider-range');
                    const valueDisplay = sliderContainer.querySelector('.slider-value');

                    slider.addEventListener('input', () => {
                        const value = parseInt(slider.value);
                        valueDisplay.textContent = value;
                        state.selectedOptions[option.id] = value;
                        if (!state.selections) state.selections = {};
                        state.selections[option.id] = value;

                        card.classList.add('answered');

                        socket.emit('select-option', {
                            roomCode: state.roomCode,
                            optionId: option.id,
                            value: value
                        });
                    });

                    if (currentValue !== 50) {
                        card.classList.add('answered');
                    }

                    card.appendChild(sliderContainer);
                }

                container.appendChild(card);
            });
        }

        // =====================================================================
        // PROFILE CARD & AVATAR RENDERING
        // =====================================================================

        function updateProfileCard() {
            // Ensure state.profile and dimensions exist
            if (!state.profile || !state.profile.dimensions) {
                return;
            }

            // Update completion in compact card
            const completion = Math.round(state.profile.completionPercent || 0);
            const completionEl = document.getElementById('completion-percent');
            if (completionEl) {
                completionEl.textContent = completion;
            }

            // Draw expressive avatar in compact card
            const canvas = document.getElementById('avatar-canvas');
            if (canvas) {
                drawExpressiveAvatar(canvas, state.profile.dimensions, state.activeDimensions, 44, '#7C4DFF');
            }

            // Also update modal if it's open
            const modal = document.getElementById('profile-modal');
            if (modal && modal.classList.contains('active')) {
                updateProfileModal();
            }
        }

        // Dimension display names and colors
        const DIM_LABELS = {
            warmth: { label: 'Warmth', color: '#FF6B6B' },
            honesty: { label: 'Honesty', color: '#51CF66' },
            autonomy: { label: 'Autonomy', color: '#FFB300' },
            memory: { label: 'Memory', color: '#7C4DFF' },
            boundaries: { label: 'Boundaries', color: '#FF8A65' },
            availability: { label: 'Availability', color: '#00BCD4' },
            transparency: { label: 'Transparency', color: '#4FC3F7' }
        };

        function updateProfileModal() {
            if (!state.profile || !state.profile.dimensions) return;

            // Dynamically build stat bars for active dimensions only
            const statsContainer = document.getElementById('modal-stats-container');
            if (statsContainer) {
                statsContainer.innerHTML = '';
                state.activeDimensions.forEach(dim => {
                    const info = DIM_LABELS[dim] || { label: dim, color: '#7C4DFF' };
                    const pct = dimToPercent(state.profile.dimensions[dim] || 0, dim);
                    const barEl = document.createElement('div');
                    barEl.className = 'stat-bar-full';
                    barEl.innerHTML = `
                        <div class="stat-bar-label">
                            <span>${info.label}</span>
                            <span>${pct}%</span>
                        </div>
                        <div class="stat-bar-background">
                            <div class="stat-bar-fill-full" style="width: ${pct}%; background: ${info.color};"></div>
                        </div>
                    `;
                    statsContainer.appendChild(barEl);
                });
            }

            // Update badges
            const badgesContainer = document.getElementById('modal-badges-container');
            if (badgesContainer) {
                badgesContainer.innerHTML = '';
                if (state.profile.badges && Array.isArray(state.profile.badges)) {
                    state.profile.badges.forEach(badge => {
                        const badgeEl = document.createElement('div');
                        badgeEl.className = 'badge';
                        badgeEl.textContent = badge;
                        badgesContainer.appendChild(badgeEl);
                    });
                }
            }

            // Draw expressive avatar in modal
            const canvas = document.getElementById('avatar-canvas-modal');
            if (canvas) {
                drawExpressiveAvatar(canvas, state.profile.dimensions, state.activeDimensions, 250, '#7C4DFF');
            }
        }

        function updateStatBar(elementId, value, dimName) {
            const bar = document.getElementById(elementId);
            if (!bar) return;

            // Convert dimension value to 0-100 percentage
            let percentage;
            if (dimName === 'warmth') {
                // warmth is -1 to 1, map to 0-100
                percentage = Math.round(((value || 0) + 1) / 2 * 100);
            } else {
                // others are 0 to 1, map to 0-100
                percentage = Math.round((value || 0) * 100);
            }

            bar.style.width = percentage + '%';

            const valueEl = document.getElementById(elementId + '-value');
            if (valueEl) {
                valueEl.textContent = percentage + '%';
            }
        }

        // =====================================================================
        // AVATAR CANVAS RENDERING - Expressive Animated Face
        // =====================================================================

        function drawExpressiveAvatar(canvas, dimensions, activeDimensions, size, accentColor) {
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            canvas.width = size;
            canvas.height = size;

            // Get dimension values with safe defaults
            // Amplify values so face is expressive even with few questions answered
            const d = dimensions || {};
            const amp = 2.5; // amplification factor for 0-1 dims
            const w = Math.max(-1, Math.min(1, (d.warmth || 0) * amp));   // -1 to 1
            const hon = Math.min(1, (d.honesty || 0) * amp);              // 0 to 1
            const aut = Math.min(1, (d.autonomy || 0) * amp);             // 0 to 1
            const mem = Math.min(1, (d.memory || 0) * amp);               // 0 to 1
            const bnd = Math.min(1, (d.boundaries || 0) * amp);           // 0 to 1
            const avl = Math.max(0.3, Math.min(1, 0.3 + (d.availability || 0) * amp)); // 0.3 to 1
            const trn = Math.min(1, (d.transparency || 0) * amp);         // 0 to 1

            const warmthNorm = (w + 1) / 2;  // normalize to 0-1
            const s = size / 250;             // scale factor (250px is reference)
            const cx = size / 2;
            const cy = size / 2;

            // Clear canvas
            ctx.fillStyle = '#0F0A2A';
            ctx.fillRect(0, 0, size, size);

            // --- AVAILABILITY: controls overall presence/opacity ---
            ctx.globalAlpha = 0.35 + avl * 0.65;

            // --- HEAD TILT (Autonomy) ---
            ctx.save();
            const tiltAngle = (aut - 0.5) * 0.18;
            ctx.translate(cx, cy);
            ctx.rotate(tiltAngle);
            ctx.translate(-cx, -cy);

            // ========== HALO / MEMORY GLOW ==========
            if (mem > 0.15 && size >= 60) {
                const haloY = cy - 42 * s;
                const haloR = (30 + mem * 30) * s;
                const grad = ctx.createRadialGradient(cx, haloY, 0, cx, haloY, haloR);
                grad.addColorStop(0, 'rgba(255, 215, 100, ' + (mem * 0.6) + ')');
                grad.addColorStop(0.6, 'rgba(255, 215, 100, ' + (mem * 0.2) + ')');
                grad.addColorStop(1, 'rgba(255, 215, 100, 0)');
                ctx.fillStyle = grad;
                ctx.beginPath();
                ctx.arc(cx, haloY, haloR, 0, Math.PI * 2);
                ctx.fill();
            }

            // ========== HEAD ==========
            const headR = 38 * s;

            // Head color from warmth
            let hue, sat, lit;
            if (warmthNorm > 0.6) {
                hue = 20 + warmthNorm * 20;
                sat = 45 + warmthNorm * 30;
                lit = 72 + warmthNorm * 8;
            } else if (warmthNorm < 0.4) {
                hue = 210 + (1 - warmthNorm) * 30;
                sat = 35 + (1 - warmthNorm) * 25;
                lit = 68 + (1 - warmthNorm) * 8;
            } else {
                hue = 265;
                sat = 30;
                lit = 76;
            }
            const headColor = 'hsl(' + hue + ', ' + sat + '%, ' + lit + '%)';

            // Head shadow
            if (size >= 60) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
                ctx.beginPath();
                ctx.ellipse(cx + 2 * s, cy + 3 * s, headR, headR * 1.08, 0, 0, Math.PI * 2);
                ctx.fill();
            }

            // Head shape
            ctx.fillStyle = headColor;
            ctx.beginPath();
            ctx.ellipse(cx, cy, headR, headR * 1.08, 0, 0, Math.PI * 2);
            ctx.fill();

            // Subtle inner glow
            if (size >= 100) {
                const innerGlow = ctx.createRadialGradient(cx - 8 * s, cy - 12 * s, 0, cx, cy, headR);
                innerGlow.addColorStop(0, 'rgba(255, 255, 255, 0.12)');
                innerGlow.addColorStop(1, 'rgba(255, 255, 255, 0)');
                ctx.fillStyle = innerGlow;
                ctx.beginPath();
                ctx.ellipse(cx, cy, headR, headR * 1.08, 0, 0, Math.PI * 2);
                ctx.fill();
            }

            // ========== BOUNDARIES BORDER ==========
            if (bnd > 0.1) {
                const borderAlpha = 0.2 + bnd * 0.6;
                const borderWidth = (1 + bnd * 5) * s;
                ctx.strokeStyle = accentColor || '#7C4DFF';
                ctx.lineWidth = borderWidth;
                ctx.globalAlpha = (0.35 + avl * 0.65) * borderAlpha;
                ctx.beginPath();
                ctx.ellipse(cx, cy, headR + (4 + bnd * 3) * s, (headR + (4 + bnd * 3) * s) * 1.08, 0, 0, Math.PI * 2);
                ctx.stroke();

                // Double ring for high boundaries
                if (bnd > 0.6 && size >= 80) {
                    ctx.lineWidth = borderWidth * 0.5;
                    ctx.globalAlpha = (0.35 + avl * 0.65) * borderAlpha * 0.4;
                    ctx.beginPath();
                    ctx.ellipse(cx, cy, headR + (9 + bnd * 5) * s, (headR + (9 + bnd * 5) * s) * 1.08, 0, 0, Math.PI * 2);
                    ctx.stroke();
                }

                ctx.globalAlpha = 0.35 + avl * 0.65;
            }

            // ========== EYES ==========
            const eyeY = cy - 6 * s;
            const eyeSpacing = 13 * s;

            // Honesty controls openness: 0 = narrow/guarded, 1 = wide open/direct
            const eyeW = 8 * s;
            const eyeH = eyeW * (0.35 + hon * 0.65);

            // Eye whites
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.ellipse(cx - eyeSpacing, eyeY, eyeW, eyeH, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(cx + eyeSpacing, eyeY, eyeW, eyeH, 0, 0, Math.PI * 2);
            ctx.fill();

            // Iris color from accent
            if (size >= 60) {
                const irisR = Math.min(eyeH * 0.7, 4.5 * s);
                ctx.fillStyle = accentColor || '#7C4DFF';
                ctx.globalAlpha = (0.35 + avl * 0.65) * 0.4;
                ctx.beginPath();
                ctx.arc(cx - eyeSpacing, eyeY, irisR + 1 * s, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(cx + eyeSpacing, eyeY, irisR + 1 * s, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 0.35 + avl * 0.65;
            }

            // Pupils -- transparency controls size (more open = larger, more readable)
            const pupilR = (2 + trn * 2.5) * s;
            ctx.fillStyle = '#1a1535';
            ctx.beginPath();
            ctx.arc(cx - eyeSpacing, eyeY, pupilR, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(cx + eyeSpacing, eyeY, pupilR, 0, Math.PI * 2);
            ctx.fill();

            // Eye highlights (sparkle)
            if (size >= 60) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.85)';
                const hlR = Math.max(1, 1.5 * s);
                ctx.beginPath();
                ctx.arc(cx - eyeSpacing + 2 * s, eyeY - 1.5 * s, hlR, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(cx + eyeSpacing + 2 * s, eyeY - 1.5 * s, hlR, 0, Math.PI * 2);
                ctx.fill();
            }

            // ========== EYEBROWS (medium+ sizes) ==========
            if (size >= 80) {
                ctx.strokeStyle = 'rgba(60, 45, 70, 0.6)';
                ctx.lineWidth = Math.max(1.5, 2 * s);
                ctx.lineCap = 'round';

                const browY = eyeY - eyeH - 5 * s;
                const browW = 9 * s;
                // High boundaries = more furrowed/assertive brows
                // High autonomy = raised inner brow (confident)
                const browFurrow = bnd * 0.25;
                const browRaise = aut * 0.15;

                // Left brow
                ctx.beginPath();
                ctx.moveTo(cx - eyeSpacing - browW, browY + browFurrow * 12 * s);
                ctx.quadraticCurveTo(cx - eyeSpacing, browY - browRaise * 12 * s - 2 * s, cx - eyeSpacing + browW, browY - browFurrow * 6 * s);
                ctx.stroke();

                // Right brow (mirrored)
                ctx.beginPath();
                ctx.moveTo(cx + eyeSpacing - browW, browY - browFurrow * 6 * s);
                ctx.quadraticCurveTo(cx + eyeSpacing, browY - browRaise * 12 * s - 2 * s, cx + eyeSpacing + browW, browY + browFurrow * 12 * s);
                ctx.stroke();
            }

            // ========== MOUTH ==========
            const mouthY = cy + 16 * s;
            const mouthW = (12 + warmthNorm * 5) * s;
            const curve = w * 14 * s;  // negative = frown, positive = smile

            // Mouth color: warm = rosy, cold = muted
            const mouthAlpha = 0.5 + warmthNorm * 0.4;
            if (warmthNorm > 0.5) {
                ctx.strokeStyle = 'rgba(190, 80, 90, ' + mouthAlpha + ')';
            } else {
                ctx.strokeStyle = 'rgba(100, 80, 120, ' + mouthAlpha + ')';
            }
            ctx.lineWidth = Math.max(1.5, 2.5 * s);
            ctx.lineCap = 'round';

            ctx.beginPath();
            ctx.moveTo(cx - mouthW, mouthY);
            ctx.quadraticCurveTo(cx, mouthY + curve, cx + mouthW, mouthY);
            ctx.stroke();

            // Big smile fill for very warm faces
            if (w > 0.4 && size >= 60) {
                ctx.fillStyle = 'rgba(190, 80, 90, ' + ((w - 0.4) * 0.35) + ')';
                ctx.beginPath();
                ctx.moveTo(cx - mouthW, mouthY);
                ctx.quadraticCurveTo(cx, mouthY + curve, cx + mouthW, mouthY);
                ctx.quadraticCurveTo(cx, mouthY + curve * 0.3, cx - mouthW, mouthY);
                ctx.fill();
            }

            // Frown emphasis for very cold faces
            if (w < -0.4 && size >= 60) {
                ctx.strokeStyle = 'rgba(100, 80, 140, 0.3)';
                ctx.lineWidth = Math.max(1, 1.5 * s);
                ctx.beginPath();
                ctx.moveTo(cx - mouthW * 0.6, mouthY + curve * 0.6 - 2 * s);
                ctx.quadraticCurveTo(cx, mouthY + curve * 0.6 + Math.abs(curve) * 0.2, cx + mouthW * 0.6, mouthY + curve * 0.6 - 2 * s);
                ctx.stroke();
            }

            // ========== CHEEK BLUSH (warmth, medium+ sizes) ==========
            if (warmthNorm > 0.55 && size >= 100) {
                const blushAlpha = (warmthNorm - 0.55) * 0.6;
                ctx.fillStyle = 'rgba(255, 140, 140, ' + blushAlpha + ')';
                ctx.beginPath();
                ctx.ellipse(cx - 22 * s, cy + 6 * s, 7 * s, 4.5 * s, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(cx + 22 * s, cy + 6 * s, 7 * s, 4.5 * s, 0, 0, Math.PI * 2);
                ctx.fill();
            }

            // ========== TRANSPARENCY DETAIL LINES (high transparency, medium+ sizes) ==========
            if (trn > 0.5 && size >= 100) {
                // Small detail marks showing "openness" -- like visible circuitry or thought lines
                ctx.strokeStyle = 'rgba(160, 140, 200, ' + ((trn - 0.5) * 0.4) + ')';
                ctx.lineWidth = 1 * s;
                // Small marks near temples
                const detailX = headR * 0.75;
                ctx.beginPath();
                ctx.moveTo(cx - detailX, cy - 15 * s);
                ctx.lineTo(cx - detailX + 4 * s, cy - 18 * s);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(cx + detailX, cy - 15 * s);
                ctx.lineTo(cx + detailX - 4 * s, cy - 18 * s);
                ctx.stroke();
                // Small dot near forehead
                ctx.fillStyle = 'rgba(160, 140, 200, ' + ((trn - 0.5) * 0.3) + ')';
                ctx.beginPath();
                ctx.arc(cx, cy - 28 * s, 2 * s, 0, Math.PI * 2);
                ctx.fill();
            }

            // Restore (undo head tilt)
            ctx.restore();
            ctx.globalAlpha = 1;
        }


        // =====================================================================
        // PROFILE CARD INTERACTIONS
        // =====================================================================

        document.getElementById('profile-card').addEventListener('click', () => {
            document.getElementById('profile-modal').classList.add('active');
            updateProfileModal();
        });

        document.getElementById('profile-modal-close').addEventListener('click', () => {
            document.getElementById('profile-modal').classList.remove('active');
        });

        document.getElementById('profile-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('profile-modal')) {
                document.getElementById('profile-modal').classList.remove('active');
            }
        });

        // =====================================================================
        // COMPARISON VIEW
        // =====================================================================

        function dimToPercent(val, dim) {
            // Convert dimension value to 0-100 percentage for display
            if (dim === 'warmth') {
                // warmth is -1 to 1, map to 0-100
                return Math.round(((val || 0) + 1) / 2 * 100);
            }
            // others are 0 to 1, map to 0-100
            return Math.round((val || 0) * 100);
        }

        function renderComparisonView() {
            const container = document.getElementById('comparison-groups');
            container.innerHTML = '';

            // Use data from comparison-data event or from groupAggregates
            const groupEntries = Object.values(state.groupAggregates);

            if (groupEntries.length === 0 && state.groups) {
                // Fallback: use groups from setup with empty data
                state.groups.forEach((group, index) => {
                    groupEntries.push({
                        groupId: group.id || index,
                        groupName: group.name || 'Group ' + String.fromCharCode(65 + index),
                        prompt: group.prompt || '',
                        aggregate: { dimensions: {}, badges: [], features: [], avatarShape: 'circle', avatarColor: '#7C4DFF' },
                        memberCount: 0
                    });
                });
            }

            // Group colors for distinct visualization
            const groupColors = ['#7C4DFF', '#00BCD4', '#FFB300', '#FF6B6B', '#51CF66', '#FF8A65', '#4FC3F7', '#E040FB'];

            groupEntries.forEach((groupData, index) => {
                const aggregate = groupData.aggregate || groupData;
                const dims = aggregate.dimensions || {};
                const groupLetter = String.fromCharCode(65 + index);
                const groupColor = groupColors[index % groupColors.length];

                const card = document.createElement('div');
                card.className = 'comparison-card';

                // Build stat bars only for active dimensions
                const statsHTML = state.activeDimensions.map(dim => {
                    const info = DIM_LABELS[dim] || { label: dim, color: '#7C4DFF' };
                    const pct = dimToPercent(dims[dim], dim);
                    return `
                        <div class="comparison-stat">
                            <span class="comparison-stat-label">${info.label}</span>
                            <div class="comparison-stat-bar">
                                <div class="comparison-stat-bar-fill" style="width: ${pct}%; background: ${info.color};"></div>
                            </div>
                            <span class="comparison-stat-value">${pct}%</span>
                        </div>
                    `;
                }).join('');

                card.innerHTML = `
                    <div class="comparison-group-name">${groupData.groupName || ('Group ' + groupLetter)}</div>

                    <div class="comparison-avatar">
                        <canvas class="comparison-avatar-canvas" width="200" height="200"></canvas>
                    </div>

                    <div class="comparison-stats">
                        ${statsHTML}
                    </div>

                    <div class="comparison-badges">
                        ${(aggregate.badges || []).map(b => `<div class="badge">${b}</div>`).join('')}
                    </div>

                    <div class="comparison-member-count">
                        ${groupData.memberCount || 0} student${(groupData.memberCount || 0) !== 1 ? 's' : ''}
                    </div>
                `;

                container.appendChild(card);

                // Draw expressive avatar for this group
                setTimeout(() => {
                    const canvas = card.querySelector('.comparison-avatar-canvas');
                    if (canvas) {
                        drawExpressiveAvatar(canvas, dims, state.activeDimensions, 200, groupColor);
                    }
                }, 100);
            });
        }

        // =====================================================================
        // CHAT VIEW RENDERING
        // =====================================================================

        function renderChatView() {
            const groupColors = ['#7C4DFF', '#00BCD4', '#FFB300', '#FF6B6B', '#51CF66', '#FF8A65', '#4FC3F7', '#E040FB'];
            const gId = state.currentChatGroupId || String(state.groupId);
            const gIdx = parseInt(gId) || 0;
            const gColor = groupColors[gIdx % groupColors.length];

            // Get the AI's profile data
            const summary = state.allGroupSummaries ? state.allGroupSummaries[gId] : null;
            const dims = summary && summary.aggregate ? summary.aggregate.dimensions : (state.profile ? state.profile.dimensions : {});
            const badges = summary && summary.aggregate ? (summary.aggregate.badges || []) : (state.profile ? state.profile.badges : []);

            // Update header
            const nameEl = document.getElementById('chat-ai-name');
            if (nameEl) {
                const isOwnGroup = (String(gId) === String(state.groupId));
                nameEl.textContent = isOwnGroup ? 'Your AI' : ((summary ? summary.groupName : 'Group') + "'s AI");
                nameEl.style.color = gColor;
            }

            const traitsEl = document.getElementById('chat-ai-traits');
            if (traitsEl && badges.length > 0) {
                traitsEl.textContent = badges.join(' - ');
            }

            // Draw avatar
            const chatCanvas = document.getElementById('chat-avatar-canvas');
            if (chatCanvas) {
                drawExpressiveAvatar(chatCanvas, dims, state.activeDimensions, 120, gColor);
            }

            // Clear messages
            const messagesEl = document.getElementById('chat-messages');
            if (messagesEl) {
                messagesEl.innerHTML = '<div class="chat-welcome"><p>Your AI is ready to talk. Say hello!</p></div>';
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            if (!input || !input.value.trim()) return;
            if (state.isWaitingForResponse) return;

            const message = input.value.trim();
            input.value = '';

            // Remove welcome message
            const welcome = document.getElementById('chat-welcome');
            if (welcome) welcome.remove();

            // Add user bubble
            const messagesEl = document.getElementById('chat-messages');
            if (messagesEl) {
                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble chat-bubble-user';
                bubble.textContent = message;
                messagesEl.appendChild(bubble);
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }

            // Show typing indicator
            const typing = document.getElementById('chat-typing');
            if (typing) typing.style.display = 'flex';

            state.isWaitingForResponse = true;
            const sendBtn = document.getElementById('chat-send-btn');
            if (sendBtn) sendBtn.disabled = true;

            // Determine target group (own group vs swap target)
            const targetGroupId = (state.phase === 'swap' && state.currentChatGroupId !== String(state.groupId))
                ? state.currentChatGroupId : undefined;

            socket.emit('send-chat-message', {
                roomCode: state.roomCode,
                message,
                targetGroupId
            });
        }

        function renderSwapGallery() {
            const gallery = document.getElementById('swap-gallery');
            const grid = document.getElementById('swap-gallery-grid');
            if (!gallery || !grid) return;

            gallery.style.display = 'block';
            grid.innerHTML = '';

            const groupColors = ['#7C4DFF', '#00BCD4', '#FFB300', '#FF6B6B', '#51CF66', '#FF8A65', '#4FC3F7', '#E040FB'];

            // Add "Your AI" card first
            const ownCard = document.createElement('div');
            ownCard.className = 'swap-ai-card' + (String(state.currentChatGroupId) === String(state.groupId) ? ' active' : '');
            const ownIdx = parseInt(state.groupId) || 0;
            ownCard.innerHTML =
                '<canvas class="swap-avatar-canvas" width="80" height="80"></canvas>' +
                '<div class="swap-ai-name" style="color: ' + groupColors[ownIdx % groupColors.length] + ';">Your AI</div>';
            ownCard.addEventListener('click', () => switchChatTarget(String(state.groupId)));
            grid.appendChild(ownCard);

            // Draw own avatar
            setTimeout(() => {
                const ownCanvas = ownCard.querySelector('.swap-avatar-canvas');
                const ownSummary = state.allGroupSummaries[String(state.groupId)];
                if (ownCanvas && ownSummary && ownSummary.aggregate) {
                    drawExpressiveAvatar(ownCanvas, ownSummary.aggregate.dimensions, state.activeDimensions, 80, groupColors[ownIdx % groupColors.length]);
                }
            }, 50);

            // Add other groups
            Object.entries(state.allGroupSummaries).forEach(([gId, summary]) => {
                if (String(gId) === String(state.groupId)) return;
                const idx = parseInt(gId) || 0;
                const gColor = groupColors[idx % groupColors.length];
                const badges = summary.aggregate ? (summary.aggregate.badges || []).slice(0, 3) : [];

                const card = document.createElement('div');
                card.className = 'swap-ai-card' + (String(state.currentChatGroupId) === String(gId) ? ' active' : '');
                card.innerHTML =
                    '<canvas class="swap-avatar-canvas" width="80" height="80"></canvas>' +
                    '<div class="swap-ai-name" style="color: ' + gColor + ';">' + (summary.groupName || 'Group') + "'s AI</div>" +
                    '<div class="swap-ai-summary">' + (badges.length > 0 ? badges.join(', ') : '') + '</div>';
                card.addEventListener('click', () => switchChatTarget(String(gId)));
                grid.appendChild(card);

                setTimeout(() => {
                    const canvas = card.querySelector('.swap-avatar-canvas');
                    if (canvas && summary.aggregate) {
                        drawExpressiveAvatar(canvas, summary.aggregate.dimensions, state.activeDimensions, 80, gColor);
                    }
                }, 50);
            });
        }

        function switchChatTarget(newGroupId) {
            if (state.currentChatGroupId === newGroupId) return;
            state.currentChatGroupId = newGroupId;
            renderChatView();
            renderSwapGallery();
        }

        // =====================================================================
        // UTILITY FUNCTIONS
        // =====================================================================

        function showError(message) {
            const container = document.querySelector('.view.active');
            if (!container) return;

            const errorEl = document.createElement('div');
            errorEl.className = 'error-message';
            errorEl.textContent = message;

            container.insertBefore(errorEl, container.firstChild);

            setTimeout(() => {
                errorEl.remove();
            }, 4000);
        }

        function showSuccess(message) {
            const container = document.querySelector('.view.active');
            if (!container) return;

            const successEl = document.createElement('div');
            successEl.className = 'success-message';
            successEl.textContent = message;

            container.insertBefore(successEl, container.firstChild);

            setTimeout(() => {
                successEl.remove();
            }, 3000);
        }

        // =====================================================================
        // INITIALIZATION
        // =====================================================================

        console.log('AI Personality Lab initialized');
    </script>
</body>
</html>
